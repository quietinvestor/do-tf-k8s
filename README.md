# DigitalOcean Terraform PostgreSQL Backend

## Table of Contents

1. [General](#1-general)
  * [Overview](#&bull;-overview)
  * [Requirements](#&bull;-requirements)
  * [Download](#&bull;-download)
2. [Terraform](#2-terraform)
  * [Install](#&bull;-install)
  * [Run](#&bull;-run)
  * [Apply Changes](#&bull;-apply-changes)
  * [Destroy](#&bull;-destroy)
  * [Variables](#&bull;-variables)
    * [terraform.tfvars](#&#9702;-terraformtfvars)
    * [Environment Variables](#&#9702;-environment-variables)

## 1. General

### &bull; Overview

PostgreSQL backend for Terraform on DigitalOcean.

### &bull; Requirements

- [DigitalOcean access token](https://docs.digitalocean.com/reference/api/create-personal-access-token/) with read and write scopes. For security, said token is passed via the environment variable `DIGITALOCEAN_ACCESS_TOKEN`. This allows to pass its value as a secret if desired. For example, to manually set the environment variable on a bash shell:
```
export DIGITALOCEAN_ACCESS_TOKEN=<DigitalOcean API token value>
```
- [Download](https://git-scm.com/downloads) and [install](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) git.
- [Download](https://www.terraform.io/downloads) and [install](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli) Terraform.

### &bull; Download

To download all the required files, input the below commands from the command line:

```
git clone https://github.com/quietinvestor/do-tf-pg-backend.git
```
## 2. Terraform

### &bull; Install

To install the Terraform DigitalOcean provider, go to the newly-downloaded `do-tf-pg-backend` directory, and initialise it:

```
cd do-tf-pg-backend
terraform init
```

### &bull; Run

Prior to executing the Terraform code and creating all the necessary DigitalOcean resources to deploy the PostgreSQL database cluster, while still inside the `do-tf-pg-backend` directory, it is recommended to input the below command from the command line to view the planned output of the DigitalOcean resources you are about to generate without actually creating them:

```
terraform plan
```

After inputting the above command, you will be prompted to provide the values for the necessary input variables, after which the planned output will be displayed.

If the result from the above is satisfactory, you can go ahead and input the below command from the command line to actually create all the necessary DigitalOcean resources to deploy the PostgreSQL database cluster:

```
terraform apply
```

Once again, after inputting the above command, you will be prompted to provide the values for the necessary input variables, after which the planned output will be displayed, alongside a prompt to continue, where you must type `yes` if you would like to go ahead and create all the necessary DigitalOcean resources to deploy the PostgreSQL database cluster.

### &bull; Apply Changes

Please note that Terraform just tracks changes in the infrastructure generated by its code. For example, if you run `terraform apply` and then manually modify any resource from the DigitalOcean Console, Terraform will not detect the change when you run again `terraform apply`. Therefore, the best way to modify the infrastructure is by modifying the corresponding Terraform code, then running `terraform apply` and typing in `yes` at the prompt to continue, once you have confirmed that the planned changes reflect what you would like to apply.

### &bull; Destroy

When the time comes to delete all your infrastructure, you can do so by running the below command:

```
terraform destroy
```

After inputting the above command, terraform will display details of all the resources that will be destroyed and will prompt you to continue. If you type `yes`, it will go ahead and destroy all the resources managed by Terraform.

Please note that Terraform just tracks changes in the infrastructure generated by its code. For example, if you run `terraform apply` and then manually add a new PostgreSQL database cluster firewall rule from the DigitalOcean Console, Terraform will not detect the change when you run `terraform destroy` and will consequently not destroy it. Therefore, the best way to modify the infrastructure is by modifying the corresponding Terraform code, then running `terraform apply` and typing in `yes` at the prompt to continue, once you have confirmed that the planned changes reflect what you would like to apply. As a result, if you later run `terraform destroy`, it will also delete the newly-created PostgreSQL database cluster firewall rule.

### &bull; Variables

Please refer to the table below for a list of the user-input Terraform variables:

| Variable | Description | Example Input | Required? |
| :--- | :--- | :---: | :---: |
| **do_db_cluster_postgresql_node_number** | Number of nodes to deploy for the PostgreSQL database cluster. | _1_ | Yes |
| **do_db_cluster_postgresql_node_size** | Size (vCPUs and Memory) slug of each node to deploy for the PostgreSQL database cluster. | _db-s-1vcpu-1gb_ | Yes |
| **do_db_cluster_postgresql_version** | PostgreSQL version to be used for the database cluster. | _15_ | Yes |
| **do_db_cluster_postgresql_window_day** | Day of the week for DigitalOcean to perform maintenance tasks on the PostgreSQL database cluster as required. | _saturday_ | Yes |
| **do_db_cluster_postgresql_window_hour** | Hour of the day for DigitalOcean to perform maintenance tasks on the PostgreSQL database cluster as required. | _2:00_ | Yes |
| **do_db_postgresql_terraform_backend_name** | Name of PostgreSQL database that will be created to contain all the schemas and corresponding Terraform `states` tables for all the remote backends created. | _pg_backend_db_ | Yes |
| **do_environment** | Environment name. This is mainly used to append it to the DigitalOcean project and PostgreSQL database cluster names. | _dev_ | Yes |
| **do_project_description** | DigitalOcean project description. | _"This is a test project"_ | Yes |
| **do_project_environment** | DigitalOcean project environment name. This has to match one of the available inputs for a project on DigitalOcean. | _Development_ | Yes |
| **do_project_name** | The name of the DigitalOcean project. Please note that, to prevent name clashes, the `do_region` and `do_environment` are appended to name, such that the final project name format is `project_name-do_region-do_environment`. Using the example values on this table, it would be `pg-backend-nyc1-dev`. | _pg-backend_ | Yes |
| **do_project_purpose** | DigitalOcean project purpose. This has to match one of the available inputs for a project on DigitalOcean. | _"Web Application"_ | Yes |
| **do_region** | Slug for one of [DigitalOcean's available regions](https://docs.digitalocean.com/products/platform/availability-matrix/). | _nyc1_ | Yes |
| **do_vpc_postgresql_description** | Description for the DigitalOcean VPC where the PostgreSQL database cluster will be deployed. | _"PostgreSQL database cluster VPC"_ | Yes |
| **do_vpc_postgresql_ip_range** | DigitalOcean VPC subnet CIDR range where the PostgreSQL database cluster will be deployed. | _10.210.0.0/16_ | Yes |
| **ip_local_admin** | For security, access to the PostgreSQL database cluster is only allowed from this local administrator IP address. This is implement by creating a DigitalOcean PostgreSQL database cluster firewall rule. | _1.1.1.1_ | Yes |
| **ip_github_actions_runner** | Similarly implemented as `ip_local_admin`, for use in a GitHub Actions CI/CD pipeline so that you may query for and pass the GitHub Actions runner's IP address at runtime to connect to the DigitalOcean PostgreSQL database cluster. In case this is not used, it has a default value of the localhost IP address: `127.0.0.1`. | _2.2.2.2_ | No |

#### &#9702; terraform.tfvars

For convenience, rather than inputting all required variables when prompted every time that you run `terraform plan` or `terraform apply`, it is recommended to create a file named `terraform.tfvars` alongside the rest of the downloaded Terraform code under `do-tf-pg-backend`, where you can include the variable names and assign the values you wish to them, separating each variable with a new line. For example,

```
do_db_cluster_postgresql_node_number    = 1
do_db_cluster_postgresql_node_size      = "db-s-1vcpu-1gb"
do_db_cluster_postgresql_version        = "15"
do_db_cluster_postgresql_window_day     = "saturday"
do_db_cluster_postgresql_window_hour    = "2:00"
do_db_postgresql_terraform_backend_name = "pg_backend_db"
do_environment                          = "dev"
do_project_description                  = "This is a test project"
do_project_environment                  = "Development"
do_project_name                         = "pg-backend"
do_project_purpose                      = "Web Development"
do_region                               = "nyc1"
do_vpc_postgresql_description           = "PostgreSQL database cluster VPC"
do_vpc_postgresql_ip_range              = "10.210.0.0/16"
ip_local_admin                          = "1.1.1.1"
```

#### &#9702; Environment Variables

You can also pass values to Terraform variables using environment variables, prepending `TF_VAR_` to their actual variable names. This allows you to pass values as secrets or environment variables using tools such as GitHub Actions.

For example, to set `ip_local_admin` in your local `bash` shell:
```
export TF_VAR_ip_local_admin="1.1.1.1"
```
